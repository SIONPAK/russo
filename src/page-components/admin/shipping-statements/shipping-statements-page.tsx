'use client'

import { useState, useEffect } from 'react'
import { format } from 'date-fns'
import { ko } from 'date-fns/locale'
import { Button } from '@/shared/ui/button'
import { Input } from '@/shared/ui/input'
import { showSuccess, showError } from '@/shared/lib/toast'
import { 
  Search, 
  Filter, 
  Download,
  FileText,
  Calendar,
  Package,
  Eye,
  Mail,
  Archive
} from 'lucide-react'

interface ShippingStatement {
  id: string
  order_id: string
  order_number: string
  company_name: string
  customer_grade: string
  created_at: string
  shipped_at: string
  status: string
  email_sent: boolean
  email_sent_at: string | null
  total_amount: number
  items: {
    product_name: string
    color: string
    size: string
    quantity: number
    shipped_quantity: number
    unit_price: number
    total_price: number
  }[]
}

export default function ShippingStatementsPage() {
  const [statements, setStatements] = useState<ShippingStatement[]>([])
  const [loading, setLoading] = useState(true)
  const [selectedStatements, setSelectedStatements] = useState<string[]>([])
  const [filters, setFilters] = useState({
    startDate: (() => {
      const date = new Date()
      date.setDate(date.getDate() - 90) // 90Ïùº Ï†ÑÏúºÎ°ú ÌôïÏû•
      return date.toISOString().split('T')[0]
    })(),
    endDate: new Date().toISOString().split('T')[0], // Ïò§Îäò
    companyName: '',
    emailSent: 'all'
  })
  const [emailSending, setEmailSending] = useState(false)

  useEffect(() => {
    fetchStatements()
  }, [filters])

  const fetchStatements = async () => {
    try {
      setLoading(true)
      console.log('üîç [Ï∂úÍ≥†Î™ÖÏÑ∏ÏÑú] Ï°∞Ìöå ÏãúÏûë')
      
      // Í∞ÄÏû• Í∞ÑÎã®Ìïú API Ìò∏Ï∂ú
      const response = await fetch('/api/admin/orders?status=all&limit=1000')
      const result = await response.json()
      
      console.log('üîç [Ï∂úÍ≥†Î™ÖÏÑ∏ÏÑú] API ÏùëÎãµ:', {
        success: result.success,
        ordersCount: result.data?.orders?.length || 0,
        error: result.error
      })

      if (result.success && result.data?.orders) {
        // Ïù¥Î©îÏùº Î∞úÏÜ° Î°úÍ∑∏ Ï°∞Ìöå
        const emailLogResponse = await fetch('/api/admin/orders/email-logs')
        const emailLogResult = await emailLogResponse.json()
        const emailLogs = emailLogResult.success ? emailLogResult.data : []

        console.log('üîç [Ï∂úÍ≥†Î™ÖÏÑ∏ÏÑú] Ïù¥Î©îÏùº Î°úÍ∑∏:', emailLogs.length)

        // Ï£ºÎ¨∏ Îç∞Ïù¥ÌÑ∞ÏôÄ Ïù¥Î©îÏùº Î°úÍ∑∏ Îß§Ïπ≠
        const statementsWithEmail = result.data.orders.map((order: any) => {
          // Ìï¥Îãπ Ï£ºÎ¨∏Ïùò Ïù¥Î©îÏùº Î∞úÏÜ° Î°úÍ∑∏ Ï∞æÍ∏∞
          const emailLog = emailLogs.find((log: any) => 
            log.order_id === order.id && 
            (log.email_type === 'shipping_statement' || log.email_type === 'confirmed_statement')
          )

          return {
            id: order.id,
            order_id: order.id,
            order_number: order.order_number,
            company_name: order.users?.company_name || 'Ïïå Ïàò ÏóÜÏùå',
            customer_grade: order.users?.customer_grade || 'general',
            created_at: order.created_at,
            shipped_at: order.shipped_at || order.created_at,
            status: order.status,
            email_sent: !!emailLog,
            email_sent_at: emailLog?.sent_at || null,
            total_amount: (() => {
              // Í≥µÍ∏âÍ∞ÄÏï° Í≥ÑÏÇ∞
              const supplyAmount = order.order_items?.reduce((sum: number, item: any) => 
                sum + (item.quantity * item.unit_price), 0) || 0;
              
              // Î∂ÄÍ∞ÄÏÑ∏Ïï° Í≥ÑÏÇ∞ (Í≥µÍ∏âÍ∞ÄÏï°Ïùò 10%, ÏÜåÏàòÏ†ê Ï†àÏÇ¨)
              const taxAmount = Math.floor(supplyAmount * 0.1);
              
              // Ï¥ù Ï£ºÎ¨∏ ÏàòÎüâ Í≥ÑÏÇ∞ (Î∞∞ÏÜ°ÎπÑ Í≥ÑÏÇ∞Ïö©)
              const totalQuantity = order.order_items?.reduce((sum: number, item: any) => 
                sum + (item.quantity || 0), 0) || 0;
              
              // Î∞∞ÏÜ°ÎπÑ Í≥ÑÏÇ∞ (20Ïû• ÎØ∏ÎßåÏùº Îïå 3,000Ïõê)
              const shippingFee = totalQuantity < 20 ? 3000 : 0;
              
              // Ï¥ù Í∏àÏï° = Í≥µÍ∏âÍ∞ÄÏï° + Î∂ÄÍ∞ÄÏÑ∏Ïï° + Î∞∞ÏÜ°ÎπÑ
              return supplyAmount + taxAmount + shippingFee;
            })(),
            items: order.order_items?.map((item: any) => ({
              product_name: item.product_name,
              color: item.color || 'Í∏∞Î≥∏',
              size: item.size || '',
              quantity: item.quantity,
              shipped_quantity: item.shipped_quantity || 0,
              unit_price: item.unit_price,
              total_price: item.unit_price * item.quantity
            })) || []
          }
        })

        console.log('üîç [Ï∂úÍ≥†Î™ÖÏÑ∏ÏÑú] ÏµúÏ¢Ö Î≥ÄÌôò ÏôÑÎ£å:', statementsWithEmail.length)
        setStatements(statementsWithEmail)
      } else {
        console.error('üîç [Ï∂úÍ≥†Î™ÖÏÑ∏ÏÑú] API Ïã§Ìå®:', result)
        setStatements([])
      }
    } catch (error) {
      console.error('üîç [Ï∂úÍ≥†Î™ÖÏÑ∏ÏÑú] Ïò§Î•ò:', error)
      setStatements([])
    } finally {
      setLoading(false)
    }
  }

  const handleEmailSend = async (statementIds: string[]) => {
    if (statementIds.length === 0) {
      alert('Î∞úÏÜ°Ìï† Î™ÖÏÑ∏ÏÑúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.')
      return
    }

    if (!confirm(`ÏÑ†ÌÉùÎêú ${statementIds.length}Í±¥Ïùò Ï∂úÍ≥† Î™ÖÏÑ∏ÏÑúÎ•º Ïù¥Î©îÏùºÎ°ú Î∞úÏÜ°ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
      return
    }

    try {
      setEmailSending(true)
      
      // statementIdsÎ•º orderIdsÎ°ú Î≥ÄÌôò
      const orderIds = statementIds.map(statementId => {
        const statement = statements.find(s => s.id === statementId)
        return statement?.order_id
      }).filter(Boolean)

      const response = await fetch('/api/admin/orders/email-shipping-statements', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ orderIds })
      })

      const result = await response.json()

      if (result.success) {
        const { successfulEmails, failedEmails } = result.data.summary
        
        if (successfulEmails > 0 && failedEmails === 0) {
          alert(`‚úÖ Ïù¥Î©îÏùº Î∞úÏÜ° ÏôÑÎ£å: ${successfulEmails}Í±¥ ÏÑ±Í≥µ`)
        } else if (successfulEmails === 0 && failedEmails > 0) {
          alert(`‚ùå Ïù¥Î©îÏùº Î∞úÏÜ° Ïã§Ìå®: ${failedEmails}Í±¥ Ïã§Ìå®`)
        } else if (successfulEmails > 0 && failedEmails > 0) {
          alert(`‚ö†Ô∏è Ïù¥Î©îÏùº Î∞úÏÜ° Î∂ÄÎ∂Ñ ÏôÑÎ£å: ÏÑ±Í≥µ ${successfulEmails}Í±¥, Ïã§Ìå® ${failedEmails}Í±¥`)
        } else {
          alert('Ïù¥Î©îÏùº Î∞úÏÜ°Ìï† ÎåÄÏÉÅÏù¥ ÏóÜÏäµÎãàÎã§.')
        }
        
        await fetchStatements()
        setSelectedStatements([])
      } else {
        alert(`‚ùå Ïù¥Î©îÏùº Î∞úÏÜ° Ïã§Ìå®: ${result.error}`)
      }
    } catch (error) {
      console.error('Email send error:', error)
      alert('Ïù¥Î©îÏùº Î∞úÏÜ° Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.')
    } finally {
      setEmailSending(false)
    }
  }

  const handleStatementDownload = async (statementId: string) => {
    try {
      const response = await fetch(`/api/admin/orders/${statementId}/statement`)

      if (response.ok) {
        const blob = await response.blob()
        const url = window.URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = `Ï∂úÍ≥†Î™ÖÏÑ∏ÏÑú_${statementId}_${new Date().toISOString().split('T')[0]}.xlsx`
        document.body.appendChild(a)
        a.click()
        window.URL.revokeObjectURL(url)
        document.body.removeChild(a)
        alert('Ï∂úÍ≥† Î™ÖÏÑ∏ÏÑúÍ∞Ä Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§.')
      } else {
        alert('Îã§Ïö¥Î°úÎìú Ïã§Ìå®: ÌååÏùºÏùÑ ÏÉùÏÑ±Ìï† Ïàò ÏóÜÏäµÎãàÎã§.')
      }
    } catch (error) {
      console.error('Download error:', error)
      alert('Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.')
    }
  }

  const handleBulkDownload = async () => {
    if (selectedStatements.length === 0) {
      alert('Îã§Ïö¥Î°úÎìúÌï† Î™ÖÏÑ∏ÏÑúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.')
      return
    }

    try {
      // Í∞Å ÏÑ†ÌÉùÎêú Î™ÖÏÑ∏ÏÑúÏóê ÎåÄÌï¥ Í∞úÎ≥Ñ Îã§Ïö¥Î°úÎìú
      for (const statementId of selectedStatements) {
        const response = await fetch(`/api/admin/orders/${statementId}/statement`)

        if (response.ok) {
          const blob = await response.blob()
          const url = window.URL.createObjectURL(blob)
          const a = document.createElement('a')
          a.href = url
          a.download = `Ï∂úÍ≥†Î™ÖÏÑ∏ÏÑú_${statementId}_${new Date().toISOString().split('T')[0]}.xlsx`
          document.body.appendChild(a)
          a.click()
          window.URL.revokeObjectURL(url)
          document.body.removeChild(a)
          
          // Îã§Ïö¥Î°úÎìú Í∞Ñ ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ Ï∂îÍ∞Ä
          await new Promise(resolve => setTimeout(resolve, 500))
        }
      }
      
      alert(`${selectedStatements.length}Í±¥Ïùò Ï∂úÍ≥† Î™ÖÏÑ∏ÏÑúÍ∞Ä Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§.`)
    } catch (error) {
      console.error('Bulk download error:', error)
      alert('ÏùºÍ¥Ñ Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.')
    }
  }

  const toggleStatementSelection = (statementId: string) => {
    setSelectedStatements(prev => 
      prev.includes(statementId) 
        ? prev.filter(id => id !== statementId)
        : [...prev, statementId]
    )
  }

  const toggleAllSelection = () => {
    setSelectedStatements(prev => 
      prev.length === statements.length ? [] : statements.map(s => s.id)
    )
  }

  const getGradeColor = (grade: string) => {
    switch (grade) {
      case 'premium': return 'text-purple-600 font-bold'
      case 'vip': return 'text-amber-600 font-bold'
      case 'general': return 'text-gray-600'
      default: return 'text-gray-600'
    }
  }

  const getGradeBadge = (grade: string) => {
    switch (grade) {
      case 'premium': return '‚≠ê'
      case 'vip': return 'üëë'
      case 'general': return ''
      default: return ''
    }
  }

  const getStatusBadge = (status: string) => {
    switch (status) {
      case 'confirmed':
        return <span className="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">ÌôïÏ†ïÎê®</span>
      case 'preparing':
        return <span className="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">Î∞∞ÏÜ°Ï§ÄÎπÑÏ§ë</span>
      case 'shipped':
        return <span className="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">Î∞∞ÏÜ°ÏôÑÎ£å</span>
      default:
        return <span className="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">{status}</span>
    }
  }

  return (
    <div className="p-6">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold">üìã Ï∂úÍ≥† Î™ÖÏÑ∏ÏÑú Í¥ÄÎ¶¨</h1>
        <div className="flex gap-2">
          <button
            onClick={() => handleEmailSend(selectedStatements)}
            disabled={emailSending || selectedStatements.length === 0}
            className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300"
          >
            {emailSending ? 'Î∞úÏÜ° Ï§ë...' : `ÏÑ†ÌÉù Î™ÖÏÑ∏ÏÑú Ïù¥Î©îÏùº Î∞úÏÜ° (${selectedStatements.length})`}
          </button>
          <button
            onClick={handleBulkDownload}
            disabled={selectedStatements.length === 0}
            className="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 disabled:bg-gray-300"
          >
            ÏÑ†ÌÉù Î™ÖÏÑ∏ÏÑú Îã§Ïö¥Î°úÎìú ({selectedStatements.length})
          </button>
          <button
            onClick={fetchStatements}
            disabled={loading}
            className="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"
          >
            ÏÉàÎ°úÍ≥†Ïπ®
          </button>
        </div>
      </div>

      {/* ÌïÑÌÑ∞ */}
      <div className="bg-white p-4 rounded-lg shadow mb-6">
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label className="block text-sm font-medium mb-1">ÏãúÏûëÏùº</label>
            <input
              type="date"
              value={filters.startDate}
              onChange={(e) => setFilters(prev => ({ ...prev, startDate: e.target.value }))}
              className="w-full p-2 border rounded"
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Ï¢ÖÎ£åÏùº</label>
            <input
              type="date"
              value={filters.endDate}
              onChange={(e) => setFilters(prev => ({ ...prev, endDate: e.target.value }))}
              className="w-full p-2 border rounded"
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">ÏóÖÏ≤¥Î™Ö</label>
            <input
              type="text"
              value={filters.companyName}
              onChange={(e) => setFilters(prev => ({ ...prev, companyName: e.target.value }))}
              placeholder="ÏóÖÏ≤¥Î™Ö Í≤ÄÏÉâ"
              className="w-full p-2 border rounded"
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Ïù¥Î©îÏùº Î∞úÏÜ°</label>
            <select
              value={filters.emailSent}
              onChange={(e) => setFilters(prev => ({ ...prev, emailSent: e.target.value }))}
              className="w-full p-2 border rounded"
            >
              <option value="all">Ï†ÑÏ≤¥</option>
              <option value="sent">Î∞úÏÜ°ÏôÑÎ£å</option>
              <option value="not_sent">ÎØ∏Î∞úÏÜ°</option>
            </select>
          </div>
        </div>
      </div>

      {/* ÌÜµÍ≥Ñ */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div className="bg-white p-4 rounded-lg shadow">
          <h3 className="text-sm font-medium text-gray-600">Ï¥ù Î™ÖÏÑ∏ÏÑú</h3>
          <p className="text-2xl font-bold text-blue-600">{statements.length}Í±¥</p>
        </div>
        <div className="bg-white p-4 rounded-lg shadow">
          <h3 className="text-sm font-medium text-gray-600">Ïù¥Î©îÏùº Î∞úÏÜ°ÏôÑÎ£å</h3>
          <p className="text-2xl font-bold text-green-600">
            {statements.filter(s => s.email_sent).length}Í±¥
          </p>
        </div>
        <div className="bg-white p-4 rounded-lg shadow">
          <h3 className="text-sm font-medium text-gray-600">Ïù¥Î©îÏùº ÎØ∏Î∞úÏÜ°</h3>
          <p className="text-2xl font-bold text-red-600">
            {statements.filter(s => !s.email_sent).length}Í±¥
          </p>
        </div>
        <div className="bg-white p-4 rounded-lg shadow">
          <h3 className="text-sm font-medium text-gray-600">Ï¥ù Ï∂úÍ≥†Í∏àÏï°</h3>
          <p className="text-2xl font-bold text-purple-600">
            {statements.reduce((sum, s) => sum + s.total_amount, 0).toLocaleString()}Ïõê
          </p>
        </div>
      </div>

      {/* Î™ÖÏÑ∏ÏÑú Î™©Î°ù */}
      <div className="bg-white rounded-lg shadow overflow-hidden">
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left">
                  <input
                    type="checkbox"
                    checked={selectedStatements.length === statements.length && statements.length > 0}
                    onChange={toggleAllSelection}
                    className="rounded"
                  />
                </th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">Ï£ºÎ¨∏Î≤àÌò∏</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">ÏóÖÏ≤¥Î™Ö</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">Ï£ºÎ¨∏ÏùºÏãú</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">Ï∂úÍ≥†Í∏àÏï°</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">Ï£ºÎ¨∏ÏÉÅÌÉú</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">Ïù¥Î©îÏùº Î∞úÏÜ°</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">ÏûëÏóÖ</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-200">
              {loading ? (
                <tr>
                  <td colSpan={8} className="px-4 py-8 text-center text-gray-500">
                    Î°úÎî© Ï§ë...
                  </td>
                </tr>
              ) : statements.length === 0 ? (
                <tr>
                  <td colSpan={8} className="px-4 py-8 text-center text-gray-500">
                    Ï∂úÍ≥† Î™ÖÏÑ∏ÏÑúÍ∞Ä ÏóÜÏäµÎãàÎã§.
                  </td>
                </tr>
              ) : (
                statements.map((statement) => (
                  <tr key={statement.id} className="hover:bg-gray-50">
                    <td className="px-4 py-3">
                      <input
                        type="checkbox"
                        checked={selectedStatements.includes(statement.id)}
                        onChange={() => toggleStatementSelection(statement.id)}
                        className="rounded"
                      />
                    </td>
                    <td className="px-4 py-3">
                      <div className="text-sm font-medium text-gray-900">
                        {statement.order_number}
                      </div>
                    </td>
                    <td className="px-4 py-3">
                      <div className={`text-sm font-medium ${getGradeColor(statement.customer_grade)}`}>
                        {getGradeBadge(statement.customer_grade)} {statement.company_name}
                      </div>
                    </td>
                    <td className="px-4 py-3">
                      <div className="text-sm text-gray-900">
                        {format(new Date(statement.created_at), 'yyyy-MM-dd HH:mm', { locale: ko })}
                      </div>
                    </td>
                    <td className="px-4 py-3">
                      <div className="text-sm font-medium text-gray-900">
                        {statement.total_amount.toLocaleString()}Ïõê
                      </div>
                    </td>
                    <td className="px-4 py-3">
                      <div className="flex items-center">
                        {getStatusBadge(statement.status)}
                      </div>
                    </td>
                    <td className="px-4 py-3">
                      <div className="flex items-center gap-2">
                        <span className={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${
                          statement.email_sent 
                            ? 'bg-green-100 text-green-800' 
                            : 'bg-red-100 text-red-800'
                        }`}>
                          {statement.email_sent ? 'Î∞úÏÜ°ÏôÑÎ£å' : 'ÎØ∏Î∞úÏÜ°'}
                        </span>
                        {statement.email_sent && statement.email_sent_at && (
                          <span className="text-xs text-gray-500">
                            {format(new Date(statement.email_sent_at), 'MM-dd HH:mm')}
                          </span>
                        )}
                      </div>
                    </td>
                    <td className="px-4 py-3">
                      <div className="flex gap-2">
                        <button
                          onClick={() => handleStatementDownload(statement.id)}
                          className="px-3 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600"
                        >
                          Îã§Ïö¥Î°úÎìú
                        </button>
                        <button
                          onClick={() => handleEmailSend([statement.id])}
                          disabled={emailSending}
                          className="px-3 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600 disabled:bg-gray-300"
                        >
                          Ïù¥Î©îÏùº Î∞úÏÜ°
                        </button>
                      </div>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  )
} 